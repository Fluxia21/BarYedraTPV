{% extends "layout.html" %}

{% block title %}Mesa {{ mesa.zona }} {{ mesa.numero }}{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">
        Mesa {{ mesa.zona }} {{ mesa.numero }}
        <span class="table-status-badge table-{{ mesa.estado }}">{{ mesa.estado|title }}</span>
    </h1>
    <div class="table-actions">
        {% if pedido_actual %}
            <button class="btn btn-success btn-lg touch-friendly" onclick="closeOrder({{ mesa.id }})">
                <i class="icon-check"></i> Cerrar Pedido
            </button>
        {% endif %}
        <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg touch-friendly">
            <i class="icon-arrow-left"></i> Volver
        </a>
    </div>
</div>

<div class="table-detail-layout">
    <!-- Panel de productos -->
    <div class="products-panel">
        <h2 class="panel-title">
            <i class="icon-package"></i> Productos Disponibles
        </h2>
        
        <!-- Productos por categoría -->
        {% for categoria, productos in productos_por_categoria.items() %}
        <div class="product-category">
            <h3 class="category-header">
                <i class="icon-tag"></i> {{ categoria }}
            </h3>
            
            <div class="products-grid-detail">
                {% for producto in productos %}
                <div class="product-item touch-friendly" onclick="addToOrder({{ mesa.id }}, {{ producto.id }})">
                    <div class="product-icon">
                        {% if producto.foto_url %}
                            <img src="{{ producto.foto_url }}" alt="{{ producto.nombre }}" class="product-mini-photo">
                        {% else %}
                            <i class="icon-package"></i>
                        {% endif %}
                    </div>
                    <div class="product-details">
                        <div class="product-name">{{ producto.nombre }}</div>
                        <div class="product-price">€{{ "%.2f"|format(producto.precio) }}</div>
                    </div>
                    <div class="add-indicator">
                        <i class="icon-plus"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Panel de pedido actual -->
    <div class="order-panel">
        <h2 class="panel-title">
            <i class="icon-receipt"></i> Pedido Actual
        </h2>
        
        {% if pedido_actual %}
            <div class="current-order">
                <div class="order-items">
                    {% set productos_pedido = pedido_actual.productos|from_json %}
                    {% for producto_id, cantidad in productos_pedido.items() %}
                        {% set producto = productos_dict[producto_id|int] %}
                        <div class="order-item">
                            <div class="item-info">
                                <span class="item-name">{{ producto.nombre }}</span>
                                <span class="item-price">€{{ "%.2f"|format(producto.precio) }}</span>
                            </div>
                            <div class="item-quantity">
                                <button class="qty-btn touch-friendly" onclick="updateQuantity({{ mesa.id }}, {{ producto.id }}, -1)">
                                    <i class="icon-minus"></i>
                                </button>
                                <span class="qty-display">{{ cantidad }}</span>
                                <button class="qty-btn touch-friendly" onclick="updateQuantity({{ mesa.id }}, {{ producto.id }}, 1)">
                                    <i class="icon-plus"></i>
                                </button>
                            </div>
                            <div class="item-total">
                                €{{ "%.2f"|format(producto.precio * cantidad) }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="order-summary">
                    <div class="summary-row total-row">
                        <span class="summary-label">Total:</span>
                        <span class="summary-value">€{{ "%.2f"|format(pedido_actual.total) }}</span>
                    </div>
                </div>
                
                <div class="order-actions">
                    <button class="btn btn-warning btn-lg touch-friendly full-width" onclick="closeOrder({{ mesa.id }})">
                        <i class="icon-check"></i> Cerrar Pedido (Mesa Lista para Pagar)
                    </button>
                </div>
            </div>
        {% else %}
            <div class="empty-order">
                <div class="empty-icon">
                    <i class="icon-shopping-cart"></i>
                </div>
                <h3>Sin pedidos</h3>
                <p>Selecciona productos para comenzar un nuevo pedido</p>
            </div>
        {% endif %}
        
        {% if mesa.estado == 'pagada' %}
            <div class="payment-actions">
                <button class="btn btn-success btn-lg touch-friendly full-width" onclick="payOrder({{ mesa.id }})">
                    <i class="icon-credit-card"></i> Procesar Pago
                </button>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Añadir producto al pedido
function addToOrder(mesaId, productoId) {
    fetch('/add_to_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `mesa_id=${mesaId}&producto_id=${productoId}`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error al añadir producto');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al añadir producto');
    });
}

// Actualizar cantidad de producto
function updateQuantity(mesaId, productoId, change) {
    fetch('/update_quantity', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `mesa_id=${mesaId}&producto_id=${productoId}&change=${change}`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error al actualizar cantidad');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar cantidad');
    });
}

// Cerrar pedido
function closeOrder(mesaId) {
    if (confirm('¿Cerrar pedido y marcar mesa como lista para pagar?')) {
        window.location.href = `/close_order/${mesaId}`;
    }
}

// Procesar pago
function payOrder(mesaId) {
    const paymentMethod = prompt('Método de pago (efectivo/tarjeta):');
    if (paymentMethod && (paymentMethod.toLowerCase() === 'efectivo' || paymentMethod.toLowerCase() === 'tarjeta')) {
        window.location.href = `/pay_order/${mesaId}?payment_method=${paymentMethod}`;
    }
}
</script>
{% endblock %}