{% extends "layout.html" %}

{% block title %}Mesa {{ mesa.zona }} {{ mesa.numero }} - Bar Yedra{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Table Header -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-table me-2"></i>Mesa {{ mesa.zona }} {{ mesa.numero }}
                    <span class="badge bg-{{ 'success' if mesa.estado == 'libre' else 'warning' if mesa.estado == 'ocupada' else 'info' }} ms-2">
                        {{ mesa.estado|title }}
                    </span>
                </h4>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Añadir Productos
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for producto in productos %}
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="product-card" onclick="addProduct({{ mesa.id }}, {{ producto.id }}, '{{ producto.nombre }}', {{ producto.precio }})">
                            <div class="product-name">{{ producto.nombre }}</div>
                            <div class="product-price">{{ "€%.2f"|format(producto.precio) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Current Order -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-receipt me-2"></i>Pedido Actual
                </h5>
            </div>
            <div class="card-body">
                {% if pedido_actual and pedido_actual.productos %}
                    {% set productos_list = pedido_actual.productos|from_json %}
                    <div class="order-items">
                        {% for item in productos_list %}
                        <div class="order-item">
                            <div class="d-flex justify-content-between">
                                <span>{{ item.cantidad }}x {{ item.nombre }}</span>
                                <span class="fw-bold">{{ "€%.2f"|format(item.subtotal) }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fs-5 fw-bold">
                        <span>Total:</span>
                        <span>{{ "€%.2f"|format(pedido_actual.total) }}</span>
                    </div>
                    
                    <!-- Order Actions -->
                    <div class="mt-3 d-grid gap-2">
                        <a href="{{ url_for('close_order', mesa_id=mesa.id) }}" 
                           class="btn btn-success btn-lg">
                            <i class="fas fa-check me-2"></i>Cerrar Pedido
                        </a>
                        <a href="{{ url_for('print_receipt', pedido_id=pedido_actual.id) }}" 
                           class="btn btn-outline-primary" target="_blank">
                            <i class="fas fa-print me-2"></i>Imprimir
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted">No hay productos en el pedido</p>
                {% endif %}
            </div>
        </div>

        <!-- Payment Section (if table is ready to pay) -->
        {% if mesa.estado == 'pagada' and pedido_actual %}
        <div class="card mt-3">
            <div class="card-header bg-warning">
                <h5 class="mb-0">
                    <i class="fas fa-credit-card me-2"></i>Procesar Pago
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('pay_order', mesa_id=mesa.id) }}">
                    <div class="d-grid gap-2">
                        <button type="submit" name="forma_pago" value="efectivo" 
                                class="btn btn-success btn-lg">
                            <i class="fas fa-money-bill-wave me-2"></i>Efectivo
                        </button>
                        <button type="submit" name="forma_pago" value="tarjeta" 
                                class="btn btn-primary btn-lg">
                            <i class="fas fa-credit-card me-2"></i>Tarjeta
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Navigation -->
        <div class="card mt-3">
            <div class="card-body">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-arrow-left me-2"></i>Volver a Mesas
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Añadir Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_to_order') }}">
                <div class="modal-body">
                    <input type="hidden" name="mesa_id" value="{{ mesa.id }}">
                    <input type="hidden" name="producto_id" id="modalProductoId">
                    
                    <div class="mb-3">
                        <label class="form-label">Producto:</label>
                        <div id="modalProductoNombre" class="fw-bold"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Precio:</label>
                        <div id="modalProductoPrecio" class="fw-bold"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cantidad" class="form-label">Cantidad:</label>
                        <input type="number" class="form-control" name="cantidad" id="cantidad" 
                               value="1" min="1" max="50">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Añadir al Pedido</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function addProduct(mesaId, productoId, nombre, precio) {
    document.getElementById('modalProductoId').value = productoId;
    document.getElementById('modalProductoNombre').textContent = nombre;
    document.getElementById('modalProductoPrecio').textContent = '€' + precio.toFixed(2);
    document.getElementById('cantidad').value = 1;
    
    var modal = new bootstrap.Modal(document.getElementById('addProductModal'));
    modal.show();
}
</script>
{% endblock %}
