{% extends "layout.html" %}

{% block title %}Mesa {{ mesa.zona }} {{ mesa.numero }}{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">
        Mesa {{ mesa.zona }} {{ mesa.numero }}
        <span class="table-status-badge table-{{ mesa.estado }}">{{ mesa.estado|title }}</span>
    </h1>
    <div class="table-actions">
        {% if pedido_actual %}
            <button class="btn btn-success btn-lg touch-friendly" onclick="closeOrder({{ mesa.id }})">
                <i class="fas fa-check"></i> Cerrar Pedido
            </button>
        {% endif %}
        <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg touch-friendly">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>
</div>

<div class="table-detail-layout">
    <!-- Panel de productos (izquierda) -->
    <div class="products-panel">
        <h2 class="panel-title">
            <i class="fas fa-box"></i> Productos Disponibles
        </h2>
        
        <!-- Categorías como cajas expansibles -->
        {% for categoria, productos in productos_por_categoria.items() %}
        <div class="category-box" data-categoria="{{ categoria }}">
            <div class="category-header-clickable" onclick="toggleCategory('{{ categoria }}')">
                <div class="category-info">
                    <i class="fas fa-{% if categoria == 'Cafés' %}coffee{% elif categoria == 'Licores' %}wine-glass{% elif categoria == 'Licores Premium' %}cocktail{% elif categoria == 'Bebidas' %}glass-water{% elif categoria == 'Cervezas' %}beer{% elif categoria == 'Vinos' %}wine-bottle{% elif categoria == 'Comidas' %}utensils{% else %}box{% endif %}"></i>
                    <h3 class="category-title">{{ categoria }}</h3>
                    <span class="product-count">({{ productos|length }} productos)</span>
                </div>
                <div class="category-arrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            
            <div class="products-container" id="products-{{ categoria }}" style="display: none;">
                <div class="products-grid-detail">
                    {% for producto in productos %}
                    <div class="product-item touch-friendly" onclick="addToOrder({{ mesa.id }}, {{ producto.id }})">
                    <div class="product-icon">
                        {% if producto.foto_url %}
                            <img src="{{ producto.foto_url }}" alt="{{ producto.nombre }}" class="product-mini-photo">
                        {% else %}
                            <i class="fas fa-utensils"></i>
                        {% endif %}
                    </div>
                    <div class="product-details">
                        <div class="product-name">{{ producto.nombre }}</div>
                        <div class="product-price">€{{ "%.2f"|format(producto.precio) }}</div>
                    </div>
                    <div class="add-indicator">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Panel de pedido actual -->
    <div class="order-panel">
        <h2 class="panel-title">
            <i class="fas fa-receipt"></i> Pedido Actual
        </h2>
        
        {% if pedido_actual and pedido_actual.total > 0 %}
            <div class="current-order">
                <div class="order-summary">
                    <div class="summary-row total-row">
                        <span class="summary-label">Total del Pedido:</span>
                        <span class="summary-value">€{{ "%.2f"|format(pedido_actual.total) }}</span>
                    </div>
                    <div class="summary-info">
                        <small>{{ pedido_actual.fecha_creacion.strftime('%H:%M') if pedido_actual.fecha_creacion else 'Ahora' }}</small>
                    </div>
                </div>
                
                <div class="order-actions">
                    <button class="btn btn-warning btn-lg touch-friendly full-width" onclick="closeOrder({{ mesa.id }})">
                        <i class="fas fa-check"></i> Cerrar Pedido (Mesa Lista para Pagar)
                    </button>
                </div>
            </div>
        {% else %}
            <div class="empty-order">
                <div class="empty-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h3>Sin pedidos</h3>
                <p>Selecciona productos para comenzar un nuevo pedido</p>
            </div>
        {% endif %}
        
        {% if mesa.estado == 'pagada' %}
            <div class="payment-actions">
                <h3 class="payment-title">
                    <i class="fas fa-credit-card"></i> Procesar Pago
                </h3>
                <div class="payment-methods">
                    <button class="btn btn-success btn-lg touch-friendly payment-method-btn" onclick="payOrder({{ mesa.id }}, 'efectivo')">
                        <i class="fas fa-money-bills"></i> 
                        <span>Efectivo</span>
                    </button>
                    <button class="btn btn-primary btn-lg touch-friendly payment-method-btn" onclick="payOrder({{ mesa.id }}, 'tarjeta')">
                        <i class="fas fa-credit-card"></i> 
                        <span>Tarjeta</span>
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Expandir/contraer categorías
function toggleCategory(categoria) {
    const container = document.getElementById(`products-${categoria}`);
    const arrow = document.querySelector(`[data-categoria="${categoria}"] .category-arrow i`);
    const categoryBox = document.querySelector(`[data-categoria="${categoria}"]`);
    
    if (container.style.display === 'none' || container.style.display === '') {
        // Expandir
        container.style.display = 'block';
        arrow.classList.remove('fa-chevron-down');
        arrow.classList.add('fa-chevron-up');
        categoryBox.classList.add('expanded');
        
        // Animación suave
        container.style.maxHeight = '0px';
        container.style.overflow = 'hidden';
        container.style.transition = 'max-height 0.3s ease-out';
        setTimeout(() => {
            container.style.maxHeight = container.scrollHeight + 'px';
        }, 10);
    } else {
        // Contraer
        container.style.maxHeight = '0px';
        arrow.classList.remove('fa-chevron-up');
        arrow.classList.add('fa-chevron-down');
        categoryBox.classList.remove('expanded');
        
        setTimeout(() => {
            container.style.display = 'none';
            container.style.maxHeight = 'none';
        }, 300);
    }
}

// Añadir producto al pedido
function addToOrder(mesaId, productoId) {
    // Crear formulario dinámico
    const form = new FormData();
    form.append('mesa_id', mesaId);
    form.append('producto_id', productoId);
    
    fetch('/add_to_order', {
        method: 'POST',
        body: form
    })
    .then(response => {
        if (response.ok) {
            // Recargar la página para mostrar el producto añadido
            location.reload();
        } else {
            alert('Error al añadir producto');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al añadir producto');
    });
}

// Cerrar pedido
function closeOrder(mesaId) {
    if (confirm('¿Cerrar pedido y marcar mesa como lista para pagar?')) {
        window.location.href = `/close_order/${mesaId}`;
    }
}

// Procesar pago con método seleccionado
function payOrder(mesaId, paymentMethod) {
    if (confirm(`¿Procesar pago con ${paymentMethod}? Se generará el ticket automáticamente.`)) {
        window.location.href = `/pay_order/${mesaId}?payment_method=${paymentMethod}`;
    }
}
</script>
{% endblock %}