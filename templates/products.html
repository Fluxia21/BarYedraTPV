{% extends "layout.html" %}

{% block title %}Productos{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">Gesti√≥n de Productos</h1>
    <button class="btn btn-primary btn-lg touch-friendly" onclick="showAddProductModal()">
        <i class="icon-plus"></i> A√±adir Producto
    </button>
</div>

<div class="content-container">
    <!-- Productos organizados por categor√≠a -->
    {% for categoria, productos in productos_por_categoria.items() %}
    <div class="category-section">
        <h2 class="category-title">
            <i class="icon-tag"></i> {{ categoria }}
            <span class="category-count">({{ productos|length }})</span>
        </h2>
        
        <div class="products-grid">
            {% for producto in productos %}
            <div class="product-card touch-friendly">
                <div class="product-image">
                    {% if producto.foto_url %}
                        <img src="{{ producto.foto_url }}" alt="{{ producto.nombre }}" class="product-photo">
                    {% else %}
                        <div class="product-placeholder">
                            <i class="icon-image"></i>
                        </div>
                    {% endif %}
                </div>
                
                <div class="product-info">
                    <h3 class="product-name">{{ producto.nombre }}</h3>
                    <p class="product-price">‚Ç¨{{ "%.2f"|format(producto.precio) }}</p>
                    {% if producto.descripcion %}
                        <p class="product-description">{{ producto.descripcion }}</p>
                    {% endif %}
                </div>
                
                <!-- Botones de prueba muy simples -->
                <p style="background: yellow; padding: 10px; margin: 10px 0;">BOTONES DE PRODUCTO:</p>
                <table style="width: 100%; margin: 10px 0;">
                    <tr>
                        <td style="width: 50%; padding: 5px;">
                            <button style="width: 100%; padding: 15px; background: #ff8c00; color: white; border: 3px solid black; font-size: 16px; font-weight: bold; border-radius: 5px;" onclick="abrirModalEdicion({{ producto.id }}, '{{ producto.nombre|e }}', {{ producto.precio }}, '{{ producto.categoria|e }}', '{{ producto.foto_url or "" }}', '{{ (producto.descripcion or "")|e }}')">
                                ‚úèÔ∏è EDITAR
                            </button>
                        </td>
                        <td style="width: 50%; padding: 5px;">
                            <button style="width: 100%; padding: 15px; background: red; color: white; border: 3px solid black; font-size: 16px; font-weight: bold;" onclick="deleteProduct({{ producto.id }}, '{{ producto.nombre }}')">
                                üóëÔ∏è ELIMINAR
                            </button>
                        </td>
                    </tr>
                </table>
            </div>

            {% endfor %}
        </div>
    </div>
    {% endfor %}
    
    {% if not productos_por_categoria %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="icon-package"></i>
        </div>
        <h3>No hay productos</h3>
        <p>A√±ade tu primer producto para comenzar</p>
        <button class="btn btn-primary btn-lg touch-friendly" onclick="showAddProductModal()">
            <i class="icon-plus"></i> A√±adir Primer Producto
        </button>
    </div>
    {% endif %}
</div>

<!-- Modal para editar producto -->
<div id="editProductModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="modal-content touch-optimized" style="background: white; border-radius: 10px; padding: 30px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> Editar Producto</h2>
            <button class="modal-close touch-friendly" onclick="hideEditProductModal()">
                <i class="icon-x"></i>
            </button>
        </div>
        
        <form id="editProductForm" method="POST" action="" class="product-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="edit_nombre" class="form-label">Nombre del Producto</label>
                    <input type="text" id="edit_nombre" name="nombre" required class="form-input touch-friendly">
                </div>
                
                <div class="form-group">
                    <label for="edit_precio" class="form-label">Precio (‚Ç¨)</label>
                    <input type="number" id="edit_precio" name="precio" step="0.01" min="0" required class="form-input touch-friendly">
                </div>
                
                <div class="form-group">
                    <label for="edit_categoria" class="form-label">Categor√≠a</label>
                    <select id="edit_categoria" name="categoria" required class="form-input touch-friendly">
                        <option value="Bebidas Calientes">‚òï Bebidas Calientes</option>
                        <option value="Bebidas Fr√≠as">ü•§ Bebidas Fr√≠as</option>
                        <option value="Alcoholicas">üç∫ Bebidas Alcoh√≥licas</option>
                        <option value="Comida">üçΩÔ∏è Comida</option>
                        <option value="Tapas">üç§ Tapas</option>
                        <option value="Postres">üç∞ Postres</option>
                        <option value="General">üì¶ General</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit_foto_url" class="form-label">URL de la Imagen</label>
                    <input type="url" id="edit_foto_url" name="foto_url" class="form-input touch-friendly" placeholder="https://ejemplo.com/imagen.jpg">
                    
                    <!-- Galer√≠a de im√°genes de un clic -->
                    <div style="margin-top: 15px;">
                        <label class="form-label" style="font-size: 14px; color: #666;">üì∏ Selecci√≥n R√°pida de Im√°genes:</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
                            <button type="button" onclick="cambiarImagen(this, 'https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=200')" style="padding: 8px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=200" style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 12px; margin-top: 4px;">‚òï Caf√©</div>
                            </button>
                            <button type="button" onclick="cambiarImagen(this, 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=200')" style="padding: 8px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=200" style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 12px; margin-top: 4px;">üçû Pan</div>
                            </button>
                            <button type="button" onclick="cambiarImagen(this, 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=200')" style="padding: 8px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=200" style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 12px; margin-top: 4px;">üçΩÔ∏è Comida</div>
                            </button>
                            <button type="button" onclick="cambiarImagen(this, 'https://images.unsplash.com/photo-1544145945-f90425340c7e?w=200')" style="padding: 8px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1544145945-f90425340c7e?w=200" style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 12px; margin-top: 4px;">ü•§ Bebida</div>
                            </button>
                            <button type="button" onclick="cambiarImagen(this, 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=200')" style="padding: 8px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=200" style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 12px; margin-top: 4px;">üç∫ Cerveza</div>
                            </button>
                            <button type="button" onclick="cambiarImagen(this, 'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=200')" style="padding: 8px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=200" style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 12px; margin-top: 4px;">üç∞ Postre</div>
                            </button>
                            <button type="button" onclick="cambiarImagen(this, 'https://images.unsplash.com/photo-1551024506-0bccd828d307?w=200')" style="padding: 8px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1551024506-0bccd828d307?w=200" style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 12px; margin-top: 4px;">üç§ Tapas</div>
                            </button>
                            <button type="button" onclick="cambiarImagen(this, 'https://images.unsplash.com/photo-1571091655789-405eb7a3a3a8?w=200')" style="padding: 8px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1571091655789-405eb7a3a3a8?w=200" style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 12px; margin-top: 4px;">üç∑ Vino</div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group form-group-full">
                    <label for="edit_descripcion" class="form-label">Descripci√≥n</label>
                    <textarea id="edit_descripcion" name="descripcion" rows="3" class="form-input touch-friendly" placeholder="Descripci√≥n opcional del producto"></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn btn-primary btn-lg touch-friendly">
                    <i class="icon-save"></i> Guardar Cambios
                </button>
                <button type="button" class="btn btn-secondary btn-lg touch-friendly" onclick="hideEditProductModal()">
                    <i class="icon-x"></i> Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para a√±adir producto - Optimizado para t√°ctil -->
<div id="addProductModal" class="modal">
    <div class="modal-content touch-optimized">
        <div class="modal-header">
            <h2><i class="icon-plus"></i> Nuevo Producto</h2>
            <button class="modal-close touch-friendly" onclick="hideAddProductModal()">
                <i class="icon-x"></i>
            </button>
        </div>
        
        <form method="POST" action="{{ url_for('add_product') }}" class="product-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="nombre" class="form-label">Nombre del Producto</label>
                    <input type="text" class="form-input touch-friendly" id="nombre" name="nombre" required 
                           placeholder="Ej: Caf√© con leche">
                </div>
                
                <div class="form-group">
                    <label for="precio" class="form-label">Precio (‚Ç¨)</label>
                    <input type="number" step="0.01" class="form-input touch-friendly" id="precio" name="precio" required 
                           placeholder="2.50">
                </div>
                
                <div class="form-group">
                    <label for="categoria" class="form-label">Categor√≠a</label>
                    <select class="form-input touch-friendly" id="categoria" name="categoria" required>
                        <option value="Bebidas Calientes">‚òï Bebidas Calientes</option>
                        <option value="Bebidas Fr√≠as">ü•§ Bebidas Fr√≠as</option>
                        <option value="Alcoholicas">üç∫ Bebidas Alcoh√≥licas</option>
                        <option value="Comida">üçΩÔ∏è Comida</option>
                        <option value="Tapas">üç§ Tapas</option>
                        <option value="Postres">üç∞ Postres</option>
                        <option value="General">üì¶ General</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label for="foto_url" class="form-label">URL de la Foto (opcional)</label>
                    <input type="url" class="form-input touch-friendly" id="foto_url" name="foto_url" 
                           placeholder="https://ejemplo.com/imagen.jpg">
                    
                    <!-- Galer√≠a de im√°genes de un clic para a√±adir -->
                    <div style="margin-top: 15px;">
                        <label class="form-label" style="font-size: 14px; color: #666;">üì∏ Selecci√≥n R√°pida de Im√°genes:</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px;">
                            <button type="button" onclick="cambiarImagenA√±adir('https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=200')" style="padding: 6px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=200" style="width: 100%; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 11px; margin-top: 2px;">‚òï Caf√©</div>
                            </button>
                            <button type="button" onclick="cambiarImagenA√±adir('https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=200')" style="padding: 6px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=200" style="width: 100%; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 11px; margin-top: 2px;">üçû Pan</div>
                            </button>
                            <button type="button" onclick="cambiarImagenA√±adir('https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=200')" style="padding: 6px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=200" style="width: 100%; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 11px; margin-top: 2px;">üçΩÔ∏è Comida</div>
                            </button>
                            <button type="button" onclick="cambiarImagenA√±adir('https://images.unsplash.com/photo-1544145945-f90425340c7e?w=200')" style="padding: 6px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1544145945-f90425340c7e?w=200" style="width: 100%; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 11px; margin-top: 2px;">ü•§ Bebida</div>
                            </button>
                            <button type="button" onclick="cambiarImagenA√±adir('https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=200')" style="padding: 6px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=200" style="width: 100%; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 11px; margin-top: 2px;">üç∫ Cerveza</div>
                            </button>
                            <button type="button" onclick="cambiarImagenA√±adir('https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=200')" style="padding: 6px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=200" style="width: 100%; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 11px; margin-top: 2px;">üç∞ Postre</div>
                            </button>
                            <button type="button" onclick="cambiarImagenA√±adir('https://images.unsplash.com/photo-1551024506-0bccd828d307?w=200')" style="padding: 6px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1551024506-0bccd828d307?w=200" style="width: 100%; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 11px; margin-top: 2px;">üç§ Tapas</div>
                            </button>
                            <button type="button" onclick="cambiarImagenA√±adir('https://images.unsplash.com/photo-1571091655789-405eb7a3a3a8?w=200')" style="padding: 6px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                                <img src="https://images.unsplash.com/photo-1571091655789-405eb7a3a3a8?w=200" style="width: 100%; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div style="font-size: 11px; margin-top: 2px;">üç∑ Vino</div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="descripcion" class="form-label">Descripci√≥n (opcional)</label>
                    <textarea class="form-input touch-friendly" id="descripcion" name="descripcion" rows="3" 
                              placeholder="Descripci√≥n breve del producto..."></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary btn-lg touch-friendly" onclick="hideAddProductModal()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary btn-lg touch-friendly">
                    <i class="icon-check"></i> Crear Producto
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddProductModal() {
    document.getElementById('addProductModal').style.display = 'flex';
}

function hideAddProductModal() {
    document.getElementById('addProductModal').style.display = 'none';
}

function mostrarModalEditar(id, nombre, precio, categoria, foto, descripcion) {
    // Llenar el formulario de edici√≥n con los datos del producto
    document.getElementById('edit_nombre').value = nombre;
    document.getElementById('edit_precio').value = precio;
    document.getElementById('edit_categoria').value = categoria;
    document.getElementById('edit_foto_url').value = foto;
    document.getElementById('edit_descripcion').value = descripcion;
    
    // Configurar la acci√≥n del formulario para enviar a la URL correcta
    document.getElementById('editProductForm').action = `/update_product/${id}`;
    
    // Mostrar el modal de edici√≥n (igual que el de a√±adir)
    document.getElementById('editProductModal').style.display = 'flex';
}

function openEditModal(id, nombre, precio, categoria, foto_url, descripcion) {
    console.log('Abriendo modal de edici√≥n para:', {id, nombre, precio, categoria, foto_url, descripcion});
    
    // Llenar el formulario con los datos del producto
    document.getElementById('edit_nombre').value = nombre || '';
    document.getElementById('edit_precio').value = precio || '';
    document.getElementById('edit_categoria').value = categoria || '';
    document.getElementById('edit_foto_url').value = foto_url || '';
    document.getElementById('edit_descripcion').value = descripcion || '';
    
    // Configurar la acci√≥n del formulario
    document.getElementById('editProductForm').action = `/update_product/${id}`;
    
    // Mostrar el modal
    document.getElementById('editProductModal').style.display = 'flex';
    
    console.log('Modal de edici√≥n abierto correctamente');
}

function hideEditProductModal() {
    document.getElementById('editProductModal').style.display = 'none';
}

function deleteProduct(id, nombre) {
    if (confirm(`¬øEst√°s seguro de eliminar "${nombre}"?`)) {
        window.location.href = `/delete_product/${id}`;
    }
}

function cambiarImagen(button, urlImagen) {
    // Cambiar el valor del campo de URL de imagen
    document.getElementById('edit_foto_url').value = urlImagen;
    
    // Resaltar el bot√≥n seleccionado
    const todosBotones = document.querySelectorAll('button[onclick*="cambiarImagen"]');
    todosBotones.forEach(btn => {
        btn.style.border = '2px solid #ddd';
        btn.style.transform = 'scale(1)';
    });
    
    // Destacar el bot√≥n seleccionado
    button.style.border = '3px solid #28a745';
    button.style.transform = 'scale(1.05)';
    
    // Mostrar confirmaci√≥n visual
    const mensaje = document.createElement('div');
    mensaje.innerHTML = '‚úÖ Imagen seleccionada';
    mensaje.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; z-index: 9999; font-weight: bold;';
    document.body.appendChild(mensaje);
    
    // Remover el mensaje despu√©s de 2 segundos
    setTimeout(() => {
        document.body.removeChild(mensaje);
    }, 2000);
}

function cambiarImagenA√±adir(urlImagen) {
    // Cambiar el valor del campo de URL de imagen para a√±adir
    document.getElementById('foto_url').value = urlImagen;
    
    // Resaltar el bot√≥n seleccionado
    const todosBotones = document.querySelectorAll('button[onclick*="cambiarImagenA√±adir"]');
    todosBotones.forEach(btn => {
        btn.style.border = '2px solid #ddd';
        btn.style.transform = 'scale(1)';
    });
    
    // Encontrar el bot√≥n que se hizo clic
    const botonSeleccionado = event.target.closest('button');
    if (botonSeleccionado) {
        botonSeleccionado.style.border = '3px solid #007bff';
        botonSeleccionado.style.transform = 'scale(1.05)';
    }
    
    // Mostrar confirmaci√≥n visual
    const mensaje = document.createElement('div');
    mensaje.innerHTML = '‚úÖ Imagen seleccionada';
    mensaje.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; z-index: 9999; font-weight: bold;';
    document.body.appendChild(mensaje);
    
    // Remover el mensaje despu√©s de 2 segundos
    setTimeout(() => {
        document.body.removeChild(mensaje);
    }, 2000);
}

function abrirModalEdicion(id, nombre, precio, categoria, foto, descripcion) {
    // Llenar el formulario con los datos del producto
    document.getElementById('edit_nombre').value = nombre;
    document.getElementById('edit_precio').value = precio;
    document.getElementById('edit_categoria').value = categoria;
    document.getElementById('edit_foto_url').value = foto;
    document.getElementById('edit_descripcion').value = descripcion;
    
    // Configurar la acci√≥n del formulario para conectar a la base de datos
    document.getElementById('editProductForm').action = '/update_product/' + id;
    
    // Mostrar el modal flotante
    document.getElementById('editProductModal').style.display = 'flex';
}
</script>

<style>
/* Estilos para botones de editar/eliminar */
.product-buttons {
    display: flex !important;
    gap: 8px !important;
    margin-top: 15px !important;
    padding: 10px !important;
    background: #f8f9fa !important;
    border-radius: 8px !important;
    width: 100% !important;
}

.btn-edit-orange, .btn-delete-red {
    flex: 1 !important;
    padding: 12px 8px !important;
    border: none !important;
    border-radius: 6px !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    text-align: center !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 4px !important;
    min-height: 40px !important;
}

.btn-edit-orange {
    background: #ff8c00 !important;
    color: white !important;
    border: 2px solid #ff8c00 !important;
}

.btn-edit-orange:hover {
    background: #ff7700 !important;
    border: 2px solid #ff7700 !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(255, 140, 0, 0.3) !important;
}

.btn-delete-red {
    background: #dc3545 !important;
    color: white !important;
    border: 2px solid #dc3545 !important;
}

.btn-delete-red:hover {
    background: #c82333 !important;
    border: 2px solid #c82333 !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3) !important;
}

.product-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 16px;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

/* Responsive */
@media (max-width: 768px) {
    .btn-edit-orange, .btn-delete-red {
        padding: 15px 20px;
        font-size: 16px;
    }
}
</style>
{% endblock %}