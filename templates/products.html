{% extends "layout.html" %}

{% block title %}Productos{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">Gesti√≥n de Productos</h1>
    <button class="btn btn-primary btn-lg touch-friendly" onclick="showAddProductModal()">
        <i class="icon-plus"></i> A√±adir Producto
    </button>
</div>

<div class="content-container">
    <!-- Productos organizados por categor√≠a -->
    {% for categoria, productos in productos_por_categoria.items() %}
    <div class="category-section">
        <h2 class="category-title">
            <i class="icon-tag"></i> {{ categoria }}
            <span class="category-count">({{ productos|length }})</span>
        </h2>
        
        <div class="products-grid">
            {% for producto in productos %}
            <div class="product-card touch-friendly" onclick="toggleProductMenu({{ producto.id }})">
                <div class="product-image">
                    {% if producto.foto_url %}
                        <img src="{{ producto.foto_url }}" alt="{{ producto.nombre }}" class="product-photo">
                    {% else %}
                        <div class="product-placeholder">
                            <i class="icon-image"></i>
                        </div>
                    {% endif %}
                </div>
                
                <div class="product-info">
                    <h3 class="product-name">{{ producto.nombre }}</h3>
                    <p class="product-price">‚Ç¨{{ "%.2f"|format(producto.precio) }}</p>
                    {% if producto.descripcion %}
                        <p class="product-description">{{ producto.descripcion }}</p>
                    {% endif %}
                </div>
                
                <!-- Men√∫ de acciones que aparece al hacer clic -->
                <div class="product-actions-menu" id="menu-{{ producto.id }}" style="display: none;">
                    <button class="btn btn-primary btn-lg touch-friendly" 
                            onclick="editProduct({{ producto.id }}); event.stopPropagation();">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-lg touch-friendly" 
                            onclick="deleteProduct({{ producto.id }}, '{{ producto.nombre }}'); event.stopPropagation();">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    <button class="btn btn-secondary btn-lg touch-friendly" 
                            onclick="toggleProductMenu({{ producto.id }}); event.stopPropagation();">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    
    {% if not productos_por_categoria %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="icon-package"></i>
        </div>
        <h3>No hay productos</h3>
        <p>A√±ade tu primer producto para comenzar</p>
        <button class="btn btn-primary btn-lg touch-friendly" onclick="showAddProductModal()">
            <i class="icon-plus"></i> A√±adir Primer Producto
        </button>
    </div>
    {% endif %}
</div>

<!-- Modal para a√±adir producto - Optimizado para t√°ctil -->
<div id="addProductModal" class="modal">
    <div class="modal-content touch-optimized">
        <div class="modal-header">
            <h2><i class="icon-plus"></i> Nuevo Producto</h2>
            <button class="modal-close touch-friendly" onclick="hideAddProductModal()">
                <i class="icon-x"></i>
            </button>
        </div>
        
        <form method="POST" action="{{ url_for('add_product') }}" class="product-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="nombre" class="form-label">Nombre del Producto</label>
                    <input type="text" class="form-input touch-friendly" id="nombre" name="nombre" required 
                           placeholder="Ej: Caf√© con leche">
                </div>
                
                <div class="form-group">
                    <label for="precio" class="form-label">Precio (‚Ç¨)</label>
                    <input type="number" step="0.01" class="form-input touch-friendly" id="precio" name="precio" required 
                           placeholder="2.50">
                </div>
                
                <div class="form-group">
                    <label for="categoria" class="form-label">Categor√≠a</label>
                    <select class="form-input touch-friendly" id="categoria" name="categoria" required>
                        <option value="Bebidas Calientes">‚òï Bebidas Calientes</option>
                        <option value="Bebidas Fr√≠as">ü•§ Bebidas Fr√≠as</option>
                        <option value="Alcoholicas">üç∫ Bebidas Alcoh√≥licas</option>
                        <option value="Comida">üçΩÔ∏è Comida</option>
                        <option value="Tapas">üç§ Tapas</option>
                        <option value="Postres">üç∞ Postres</option>
                        <option value="General">üì¶ General</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label for="foto_url" class="form-label">URL de la Foto (opcional)</label>
                    <input type="url" class="form-input touch-friendly" id="foto_url" name="foto_url" 
                           placeholder="https://ejemplo.com/imagen.jpg">
                </div>
                
                <div class="form-group full-width">
                    <label for="descripcion" class="form-label">Descripci√≥n (opcional)</label>
                    <textarea class="form-input touch-friendly" id="descripcion" name="descripcion" rows="3" 
                              placeholder="Descripci√≥n breve del producto..."></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary btn-lg touch-friendly" onclick="hideAddProductModal()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary btn-lg touch-friendly">
                    <i class="icon-check"></i> Crear Producto
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddProductModal() {
    document.getElementById('addProductModal').style.display = 'flex';
}

function hideAddProductModal() {
    document.getElementById('addProductModal').style.display = 'none';
}

function toggleProductMenu(productId) {
    // Cerrar todos los men√∫s abiertos
    const allMenus = document.querySelectorAll('.product-actions-menu');
    allMenus.forEach(menu => {
        if (menu.id !== `menu-${productId}`) {
            menu.style.display = 'none';
        }
    });
    
    // Mostrar/ocultar el men√∫ del producto seleccionado
    const menu = document.getElementById(`menu-${productId}`);
    if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
    } else {
        menu.style.display = 'none';
    }
}

function editProduct(id) {
    window.location.href = `/edit_product/${id}`;
}

function deleteProduct(id, nombre) {
    if (confirm(`¬øEst√°s seguro de eliminar "${nombre}"?`)) {
        window.location.href = `/delete_product/${id}`;
    }
}

// Cerrar men√∫s al hacer clic fuera
document.addEventListener('click', function(event) {
    if (!event.target.closest('.product-card')) {
        const allMenus = document.querySelectorAll('.product-actions-menu');
        allMenus.forEach(menu => {
            menu.style.display = 'none';
        });
    }
});
</script>

<style>
/* Estilos para el men√∫ de acciones de productos */
.product-card {
    position: relative;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.product-actions-menu {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 15px;
    padding: 20px;
    z-index: 100;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.product-actions-menu .btn {
    width: 100%;
    max-width: 200px;
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.product-actions-menu .btn-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
}

.product-actions-menu .btn-primary:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: scale(1.05);
}

.product-actions-menu .btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
}

.product-actions-menu .btn-danger:hover {
    background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
    transform: scale(1.05);
}

.product-actions-menu .btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    color: white;
}

.product-actions-menu .btn-secondary:hover {
    background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
    transform: scale(1.05);
}

/* Indicador visual para productos clicables */
.product-card::before {
    content: "üëÜ Toca para opciones";
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
}

.product-card:hover::before {
    opacity: 1;
}

/* Responsive para m√≥viles */
@media (max-width: 768px) {
    .product-actions-menu .btn {
        padding: 15px 20px;
        font-size: 18px;
    }
    
    .product-card::before {
        content: "üëÜ";
        font-size: 16px;
    }
}
</style>
{% endblock %}